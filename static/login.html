<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPG 冒险游戏 - 登录</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>
<body class="bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 min-h-screen">
    <div id="app">
        <!-- Main Container -->
        <div class="min-h-screen flex items-center justify-center p-4">
            <div class="max-w-md w-full">
                <!-- Logo/Title -->
                <div class="text-center mb-8">
                    <h1 class="text-5xl font-bold text-white mb-2">⚔️ RPG 冒险</h1>
                    <p class="text-blue-200">开始你的传奇之旅</p>
                </div>

                <!-- Login/Register Card -->
                <div class="bg-white bg-opacity-10 backdrop-blur-lg rounded-2xl shadow-2xl p-8">
                    <!-- Tabs -->
                    <div class="flex mb-6 bg-black bg-opacity-20 rounded-lg p-1">
                        <button
                            @click="activeTab = 'login'"
                            :class="[
                                'flex-1 py-2 px-4 rounded-md font-medium transition-all',
                                activeTab === 'login'
                                    ? 'bg-blue-500 text-white shadow-lg'
                                    : 'text-blue-200 hover:text-white'
                            ]">
                            登录
                        </button>
                        <button
                            @click="activeTab = 'register'"
                            :class="[
                                'flex-1 py-2 px-4 rounded-md font-medium transition-all',
                                activeTab === 'register'
                                    ? 'bg-blue-500 text-white shadow-lg'
                                    : 'text-blue-200 hover:text-white'
                            ]">
                            注册
                        </button>
                    </div>

                    <!-- Error Message -->
                    <div v-if="errorMessage" class="mb-4 p-3 bg-red-500 bg-opacity-20 border border-red-500 rounded-lg">
                        <p class="text-red-200 text-sm">{{ errorMessage }}</p>
                    </div>

                    <!-- Success Message -->
                    <div v-if="successMessage" class="mb-4 p-3 bg-green-500 bg-opacity-20 border border-green-500 rounded-lg">
                        <p class="text-green-200 text-sm">{{ successMessage }}</p>
                    </div>

                    <!-- Login Form -->
                    <form v-if="activeTab === 'login'" @submit.prevent="handleLogin" class="space-y-4">
                        <div>
                            <label class="block text-blue-200 text-sm font-medium mb-2">用户名</label>
                            <input
                                v-model="loginForm.username"
                                type="text"
                                required
                                class="w-full px-4 py-3 bg-white bg-opacity-20 border border-blue-300 rounded-lg text-white placeholder-blue-300 focus:outline-none focus:ring-2 focus:ring-blue-400"
                                placeholder="输入用户名">
                        </div>

                        <div>
                            <label class="block text-blue-200 text-sm font-medium mb-2">密码</label>
                            <input
                                v-model="loginForm.password"
                                type="password"
                                required
                                class="w-full px-4 py-3 bg-white bg-opacity-20 border border-blue-300 rounded-lg text-white placeholder-blue-300 focus:outline-none focus:ring-2 focus:ring-blue-400"
                                placeholder="输入密码">
                        </div>

                        <button
                            type="submit"
                            :disabled="isLoading"
                            class="w-full py-3 bg-gradient-to-r from-blue-500 to-purple-600 text-white font-bold rounded-lg hover:from-blue-600 hover:to-purple-700 transition-all transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                            <span v-if="!isLoading">登录</span>
                            <span v-else>登录中...</span>
                        </button>
                    </form>

                    <!-- Register Form -->
                    <form v-if="activeTab === 'register'" @submit.prevent="handleRegister" class="space-y-4">
                        <div>
                            <label class="block text-blue-200 text-sm font-medium mb-2">用户名</label>
                            <input
                                v-model="registerForm.username"
                                type="text"
                                required
                                minlength="3"
                                class="w-full px-4 py-3 bg-white bg-opacity-20 border border-blue-300 rounded-lg text-white placeholder-blue-300 focus:outline-none focus:ring-2 focus:ring-blue-400"
                                placeholder="至少3个字符">
                        </div>

                        <div>
                            <label class="block text-blue-200 text-sm font-medium mb-2">邮箱 (可选)</label>
                            <input
                                v-model="registerForm.email"
                                type="email"
                                class="w-full px-4 py-3 bg-white bg-opacity-20 border border-blue-300 rounded-lg text-white placeholder-blue-300 focus:outline-none focus:ring-2 focus:ring-blue-400"
                                placeholder="your@email.com">
                        </div>

                        <div>
                            <label class="block text-blue-200 text-sm font-medium mb-2">密码</label>
                            <input
                                v-model="registerForm.password"
                                type="password"
                                required
                                minlength="6"
                                class="w-full px-4 py-3 bg-white bg-opacity-20 border border-blue-300 rounded-lg text-white placeholder-blue-300 focus:outline-none focus:ring-2 focus:ring-blue-400"
                                placeholder="至少6个字符">
                        </div>

                        <div>
                            <label class="block text-blue-200 text-sm font-medium mb-2">确认密码</label>
                            <input
                                v-model="registerForm.confirmPassword"
                                type="password"
                                required
                                class="w-full px-4 py-3 bg-white bg-opacity-20 border border-blue-300 rounded-lg text-white placeholder-blue-300 focus:outline-none focus:ring-2 focus:ring-blue-400"
                                placeholder="再次输入密码">
                        </div>

                        <button
                            type="submit"
                            :disabled="isLoading"
                            class="w-full py-3 bg-gradient-to-r from-green-500 to-blue-600 text-white font-bold rounded-lg hover:from-green-600 hover:to-blue-700 transition-all transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed">
                            <span v-if="!isLoading">注册</span>
                            <span v-else>注册中...</span>
                        </button>
                    </form>
                </div>

                <!-- Footer -->
                <p class="text-center text-blue-200 text-sm mt-6">
                    基于 Gemini AI 的沉浸式 RPG 体验
                </p>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    activeTab: 'login',
                    isLoading: false,
                    errorMessage: '',
                    successMessage: '',
                    loginForm: {
                        username: '',
                        password: ''
                    },
                    registerForm: {
                        username: '',
                        email: '',
                        password: '',
                        confirmPassword: ''
                    }
                };
            },

            methods: {
                async handleLogin() {
                    this.errorMessage = '';
                    this.successMessage = '';
                    this.isLoading = true;

                    try {
                        const response = await fetch('/api/auth/login', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            credentials: 'include',
                            body: JSON.stringify(this.loginForm)
                        });

                        const data = await response.json();

                        if (data.success) {
                            this.successMessage = data.message;
                            // Redirect based on character existence
                            setTimeout(() => {
                                if (data.user.has_character) {
                                    window.location.href = '/game.html';
                                } else {
                                    window.location.href = '/character.html';
                                }
                            }, 500);
                        } else {
                            this.errorMessage = data.error;
                        }
                    } catch (error) {
                        this.errorMessage = '网络错误，请稍后重试';
                        console.error('Login error:', error);
                    } finally {
                        this.isLoading = false;
                    }
                },

                async handleRegister() {
                    this.errorMessage = '';
                    this.successMessage = '';

                    // Validate passwords match
                    if (this.registerForm.password !== this.registerForm.confirmPassword) {
                        this.errorMessage = '两次输入的密码不一致';
                        return;
                    }

                    this.isLoading = true;

                    try {
                        const response = await fetch('/api/auth/register', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                username: this.registerForm.username,
                                email: this.registerForm.email,
                                password: this.registerForm.password
                            })
                        });

                        const data = await response.json();

                        if (data.success) {
                            this.successMessage = data.message;
                            // Switch to login tab
                            setTimeout(() => {
                                this.activeTab = 'login';
                                this.loginForm.username = this.registerForm.username;
                            }, 1500);
                        } else {
                            this.errorMessage = data.error;
                        }
                    } catch (error) {
                        this.errorMessage = '网络错误，请稍后重试';
                        console.error('Register error:', error);
                    } finally {
                        this.isLoading = false;
                    }
                }
            },

            mounted() {
                // Check if already logged in
                fetch('/api/auth/check', {
                    credentials: 'include'
                })
                .then(res => res.json())
                .then(data => {
                    if (data.authenticated) {
                        if (data.user.has_character) {
                            window.location.href = '/game.html';
                        } else {
                            window.location.href = '/character.html';
                        }
                    }
                })
                .catch(err => console.error('Auth check error:', err));
            }
        }).mount('#app');
    </script>
</body>
</html>
